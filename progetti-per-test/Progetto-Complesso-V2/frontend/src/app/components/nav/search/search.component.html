<form [formGroup]="searchForm" (ngSubmit)="performSearch()" class="rounded-[15px] bg-[#484848] px-[8px] py-[4px]" x-test-tpl-form-1>
  <div class="flex items-center w-full" x-test-hook-div-2>
    <img
      [src]="isAnyPanelOpen() ? 'arrow-back.png' : 'search.png'"
      [alt]="isAnyPanelOpen() ? 'Chiudi' : 'Cerca'"
      class="size-6 mr-2 cursor-pointer"
      (click)="closeAllPanelsOrOpenSearch()"
    x-test-hook-img-3 />
    <input #searchInput
      class="w-full bg-transparent md:text-m text-sm placeholder-[#C3C3C3] focus:outline-none"
      type="text"
      name="tags"
      placeholder="Cerca su MemeMuseum"
      formControlName="tags"
      (focus)="openSearchPanel()"
    x-test-hook-input-4 />
    @if(isAnyFilterApplied()) {
      <button type="button" (click)="clearSearch()" class="p-1 rounded-full bg-[#63B2FF] hover:bg-blue-400 active:bg-blue-500 focus:outline-none cursor-pointer" x-test-hook-button-5>
        <img src="delete.png" alt="Cancella la ricerca" class="object-contain" x-test-hook-img-6>
      </button>
    }
  </div>

  @if(isSearchPanelOpen()) {
    <p class="m-0 text-xs pt-1 text-center" x-test-hook-p-7>
      <u x-test-hook-u-8>Suggerimento:</u> separa i tag con una virgola.
    </p>
    <div class="md:mt-3 mt-2 mb-1 flex justify-center space-x-3" x-test-hook-div-9>
      <button
        type="button"
        (click)="openFilterPanel()" 
        class="py-1 px-3 rounded-lg bg-[#C3C3C3] text-black hover:bg-blue-400 active:bg-blue-500 font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[#484848] focus:ring-[#63B2FF] cursor-pointer"
       x-test-hook-button-10>
        <img src="filter.png" alt="Filtri" class="size-6 inline-block" x-test-hook-img-11>
        Filtri
      </button>
      <button
        type="submit"
        aria-label="Cerca per tag"
        class="py-1 px-4 rounded-lg bg-[#63B2FF] text-black hover:bg-blue-400 active:bg-blue-500 font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[#484848] focus:ring-[#63B2FF] cursor-pointer"
       x-test-hook-button-12>
        Cerca
      </button>
    </div>
  }
  @if(isFilterPanelOpen()) {
    <div class="w-full md:mt-4 mt-2 mb-1 flex flex-col items-center justify-evenly gap-3" x-test-hook-div-13>
      <div class="relative inline-block text-left" x-test-hook-div-14>
        <div class="inline-flex rounded-md shadow-sm" role="group" x-test-hook-div-15>
          <button type="button"
            class="inline-flex items-center px-4 py-1 border border-transparent text-center text-sm font-medium rounded-l-md text-black bg-[#C3C3C3]" x-test-hook-button-16>
            Ordina per: <span class="font-bold ml-1" x-test-hook-span-17>{{ selectedFilterOption() }}</span>
          </button>
    
          <button type="button"
            class="-ml-px inline-flex items-center px-1 py-1 border border-transparent text-sm font-medium rounded-r-md text-black bg-[#63B2FF] hover:bg-blue-400 active:bg-blue-500 cursor-pointer"
            (click)="toggleFilterDropdown()" [attr.aria-expanded]="isFilterDropdownOpen()"
            data-testid="search-filter-dropdown-toggle" x-test-hook-button-18>
            <span class="sr-only" x-test-hook-span-19>Apri opzioni filtro</span>
            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" x-test-hook-svg-20>
              <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" x-test-hook-path-21 />
            </svg>
          </button>
        </div>
    
        <div
          class="dropdown-menu absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-20"
          [ngClass]="{'hidden': !isFilterDropdownOpen(), 'open': isFilterDropdownOpen()}" role="menu"
          aria-orientation="vertical" aria-labelledby="dropdown-trigger" tabindex="-1" x-test-hook-div-22>
          <div class="py-1" role="none" x-test-hook-div-23>
            <a href="#" (click)="selectFilterOption('recente'); $event.preventDefault()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem" data-testid="filter-option-recente" x-test-hook-a-24>
              Più recenti
            </a>
            <a href="#" (click)="selectFilterOption('meno_recente'); $event.preventDefault()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem" data-testid="filter-option-meno_recente" x-test-hook-a-25>
              Meno recenti
            </a>
            <a href="#" (click)="selectFilterOption('piu_piaciuti'); $event.preventDefault()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem" data-testid="filter-option-piu_piaciuti" x-test-hook-a-26>
              Più piaciuti
            </a>
            <a href="#" (click)="selectFilterOption('meno_piaciuti'); $event.preventDefault()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem" data-testid="filter-option-meno_piaciuti" x-test-hook-a-27>
              Meno piaciuti
            </a>
          </div>
        </div>
      </div>
      
      <div class="flex rounded-md shadow-sm" x-test-hook-div-28>
        <div class="flex items-center pl-4 py-1 text-center text-sm font-medium rounded-l-md text-black bg-[#C3C3C3] flex-grow relative" x-test-hook-div-29>
          <span x-test-hook-span-30>A partire da:</span>
          <div class="relative flex-grow" x-test-hook-div-31>
            <input
              #dateInputRef
              type="date"
              class="ml-2 bg-transparent text-black focus:outline-none border-none p-0 date-input-no-calendar-icon font-bold w-full relative z-10"
              formControlName="selectedDate"
              name="startDate"
             x-test-hook-input-32>
          </div>
        </div>
        <button type="button"
          class="-ml-px inline-flex items-center px-1 py-1 border border-transparent text-sm font-medium rounded-r-md text-black bg-[#63B2FF] hover:bg-blue-400 active:bg-blue-500 cursor-pointer"
          (click)="openDatePicker()"
          data-testid="search-datepicker-button" x-test-hook-button-33>
          <img src="calendar.png" alt="Seleziona data" class="h-5 w-5 object-contain" x-test-hook-img-34>
        </button>
      </div>

      <button
        type="submit"
        aria-label="Applica filtri e cerca"
        class="py-1 px-4 rounded-lg bg-[#63B2FF] text-black hover:bg-blue-400 active:bg-blue-500 font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[#484848] focus:ring-[#63B2FF] cursor-pointer"
        data-testid="search-apply-filters-button"
       x-test-hook-button-35>
        Cerca
      </button>
    </div>
  }
</form>