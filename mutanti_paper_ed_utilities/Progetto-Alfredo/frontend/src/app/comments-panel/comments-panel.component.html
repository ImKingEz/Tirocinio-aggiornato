@if (isOpen) {
  <div (click)="$event.stopPropagation()"
    class="absolute inset-0 bg-white bg-opacity-95 backdrop-blur-sm flex flex-col">
      <div class="flex justify-between items-center p-3 border-b border-gray-200 flex-shrink-0">
        <h3 class="text-md font-bold text-gray-800">Commenti</h3>
        <button (click)="requestClose()" class="p-1 rounded-full hover:bg-gray-200">
          <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg>
        </button>
      </div>

      <div class="flex-grow overflow-y-auto">
        @if(isLoading) {
          <p class="p-4 text-center text-gray-500">Caricamento...</p>
        } @else if(error) {
          <p class="p-4 text-center text-red-500">{{ error }}</p>
        } @else {
          @for (comment of comments; track comment.id) {
            <app-comment-item [comment]="comment"></app-comment-item>
          } @empty {
            <p class="p-4 text-center text-gray-500 italic text-sm">Nessun commento. Sii il primo!</p>
          }
        }
      </div>

      @if(comments.length > 0) {
        <div class="p-2 border-t border-gray-200 bg-gray-50 flex-shrink-0">
          <div class="flex items-center justify-center gap-3">
            <button type="button" (click)="goToPreviousPage()" [disabled]="currentPage === 1 || isLoading"
              class="p-1 rounded-md hover:bg-gray-200 disabled:opacity-40 disabled:cursor-not-allowed transition-colors duration-150 ease-in-out"
              aria-label="Pagina precedente">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" class="w-4 h-4 fill-gray-700">
                <path d="M560-240 320-480l240-240 56 56-184 184 184 184-56 56Z" />
              </svg>
            </button>

            <span class="text-sm font-semibold text-gray-700">
              {{ currentPage }}
            </span>
            <button type="button" (click)="goToNextPage()" [disabled]="currentPage >= totalPages || isLoading"
              class="p-1 rounded-md hover:bg-gray-200 disabled:opacity-40 disabled:cursor-not-allowed transition-colors duration-150 ease-in-out"
              aria-label="Pagina successiva">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" class="w-4 h-4 fill-gray-700">
                <path d="M504-480 320-664l56-56 240 240-240 240-56-56 184-184Z" />
              </svg>
            </button>
          </div>
        </div>
      }
      
      <div class="p-3 border-t border-gray-200 bg-gray-50 flex-shrink-0">
        <textarea data-testid="comment-input-textarea" id="comment-textarea" [formControl]="newCommentControl" placeholder="Scrivi un commento..."
          class="w-full p-2 text-sm border border-gray-300 rounded-md focus:ring-1 focus:ring-amber-500 focus:border-amber-500"></textarea>
        <button data-testid="comment-submit-button" id="comment-button" (click)="submitComment()" [disabled]="newCommentControl.invalid"  
          class="w-full mt-2 bg-[#D97706] text-white py-1.5 px-4 rounded-md hover:bg-[#B45309] text-sm disabled:opacity-50 disabled:cursor-not-allowed">Invia</button>
      </div>
  </div>
}